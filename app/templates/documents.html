{% extends "base.html" %}

{% block title %}Documents - SEC Filing Manager{% endblock %}

{% block content %}
<h2 class="mb-4">Document History</h2>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="fund_id" class="form-label">Filter by Fund</label>
                <select class="form-select" id="fund_id" name="fund_id" onchange="this.form.submit()">
                    <option value="">All Funds</option>
                    {% for fund in funds %}
                    <option value="{{ fund.id }}" {% if selected_fund_id == fund.id %}selected{% endif %}>
                        {{ fund.name or fund.cik }} {% if fund.ticker %}({{ fund.ticker }}){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <span class="text-muted">Showing {{ documents|length }} of {{ total_documents }} documents</span>
            </div>
        </form>
    </div>
</div>

<!-- Documents Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Documents</h5>
        <input type="text" id="documentsSearch" class="form-control form-control-sm" style="max-width: 250px;" placeholder="Filter by fund or ticker...">
    </div>
    <div class="card-body">
        {% if documents %}
        <div class="table-responsive">
            <table id="documentsTable" class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Filed Date</th>
                        <th>Fund</th>
                        <th>Form Type</th>
                        <th>Reporting Period</th>
                        <th>File Name</th>
                        <th>Size</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documents %}
                    <tr data-fund="{{ (doc.fund.name or '')|lower }}" data-ticker="{{ (doc.fund.ticker or '')|lower }}">
                        <td>{{ doc.filed_at.strftime('%Y-%m-%d') }}</td>
                        <td>{{ doc.fund.name or doc.fund.cik }}</td>
                        <td><span class="badge bg-secondary">{{ doc.form_type }}</span></td>
                        <td>{{ doc.reporting_period_end.strftime('%Y-%m-%d') if doc.reporting_period_end else '-' }}</td>
                        <td>
                            <span title="{{ doc.local_path }}">
                                {{ doc.local_filename[:50] }}{% if doc.local_filename|length > 50 %}...{% endif %}
                            </span>
                        </td>
                        <td>
                            {% if doc.file_size_bytes %}
                                {% if doc.file_size_bytes > 1048576 %}
                                    {{ (doc.file_size_bytes / 1048576)|round(1) }} MB
                                {% else %}
                                    {{ (doc.file_size_bytes / 1024)|round(1) }} KB
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ page - 1 }}{% if selected_fund_id %}&fund_id={{ selected_fund_id }}{% endif %}">Previous</a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ p }}{% if selected_fund_id %}&fund_id={{ selected_fund_id }}{% endif %}">{{ p }}</a>
                    </li>
                    {% elif p == page - 3 or p == page + 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ page + 1 }}{% if selected_fund_id %}&fund_id={{ selected_fund_id }}{% endif %}">Next</a>
                </li>
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <p class="text-muted mb-0">No documents found. {% if not funds %}Add some funds first, then{% else %}Try{% endif %} running a scan to download documents.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Table filtering functionality
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('documentsSearch');
    const table = document.getElementById('documentsTable');

    if (!input || !table) return;

    input.addEventListener('input', function() {
        const filter = this.value.toLowerCase().trim();
        const rows = table.querySelectorAll('tbody tr');

        rows.forEach(function(row) {
            const fund = row.dataset.fund || '';
            const ticker = row.dataset.ticker || '';

            if (filter === '' || fund.includes(filter) || ticker.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}
